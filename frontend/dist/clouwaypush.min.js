/**
 * clouwaypush - 2016-01-08
 *
 * Copyright (c) 2016 clouWay ltd
 */
!function(a,b,c){b.module("clouway-push",[]).provider("pushApi",function(){this.subscriberLength=15,this.endpoints={serviceUrl:""},this.timeIntervals={keepAlive:60,channelReconnect:5},this.backendServiceUrl=function(a){return this.endpoints.serviceUrl=a,this},this.keepAliveTimeInterval=function(a){return this.timeIntervals.keepAlive=a,this},this.reconnectTimeInterval=function(a){return this.timeIntervals.channelReconnect=a,this},this.$get=["$rootScope","$interval","$timeout","$window","$http",function(a,c,d,e,f){var g,h,i=this.subscriberLength,j=this.timeIntervals,k=this.endpoints,l={},m={},n=function(a){for(var b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456",c=[],d=0;a>d;){d++;var e=Math.floor(Math.random()*b.length);c.push(b.charAt(e))}return c.join("")},o=function(a){var c=a.data,d=b.fromJson(c),e=l[d.event];b.forEach(e,function(a){a(d)})},p=function(a){var b=new goog.appengine.Channel(a),c=b.open();c.onmessage=o,c.onerror=function(a){t()}},q=function(a,b){var c=m.openConnection(),d={subscriber:c,eventName:a,correlationId:b};k.serviceUrl&&""!==k.serviceUrl&&f.put(k.serviceUrl,"",{params:d}).then(function(a){})},r=function(a,b){var c={subscriber:g,eventName:a,correlationId:b};k.serviceUrl&&""!==k.serviceUrl&&f["delete"](k.serviceUrl,{params:c}).then(function(a){})},s=function(){var a={subscriber:g};f.post(k.serviceUrl,"",{params:a}).then(function(a){})},t=function(){var a={subscriber:g};f.get(k.serviceUrl,{params:a}).then(function(a){p(a.data),h||(h=c(s,1e3*j.keepAlive))},function(){d(t,1e3*j.channelReconnect,!0)})};return m.openConnection=function(a){return g?g:(a||(a=n(i)),g=a,t(a),a)},m.fireEvent=function(a,c){var d=b.extend({event:a},c);o({data:d})},m.bind=function(a,b){return m.bindId(a,"",b)},m.bindId=function(c,d,e){d||(d="");var f=c+d;b.isUndefined(l[f])&&(l[f]=[]);var g=function(b){e(b),a.$apply()};return q(c,d),l[f].push(g),g},m.unbind=function(a,b){m.unbindId(a,"",b)},m.unbindId=function(a,c,d){c||(c="");var e=a+c;if(e in l){if(b.isUndefined(d))return r(a,c),void delete l[e];var f=l[e].indexOf(d);0>f||(l[e].splice(f,1),l[e].length||(r(a,c),delete l[e]))}},m}]}).config(["pushApiProvider",function(a){var b="/pushService",c=30,d=10;a.backendServiceUrl(b).keepAliveTimeInterval(c).reconnectTimeInterval(d)}])}(window,window.angular);